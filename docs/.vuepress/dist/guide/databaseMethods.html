<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>云开发：数据库和云存储操作 | 职念</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.69dd57bd.css" as="style"><link rel="preload" href="/assets/js/app.9bb55e6e.js" as="script"><link rel="preload" href="/assets/js/2.6f94c7ae.js" as="script"><link rel="preload" href="/assets/js/12.26daf54b.js" as="script"><link rel="preload" href="/assets/js/22.1a0921fe.js" as="script"><link rel="prefetch" href="/assets/js/10.3e7901bd.js"><link rel="prefetch" href="/assets/js/11.c73e6c04.js"><link rel="prefetch" href="/assets/js/13.2b2dc112.js"><link rel="prefetch" href="/assets/js/14.48db07fb.js"><link rel="prefetch" href="/assets/js/15.89bcdc74.js"><link rel="prefetch" href="/assets/js/16.425ab4da.js"><link rel="prefetch" href="/assets/js/17.cb7757ec.js"><link rel="prefetch" href="/assets/js/18.8bece9e0.js"><link rel="prefetch" href="/assets/js/19.afc94a07.js"><link rel="prefetch" href="/assets/js/20.a50ed6c1.js"><link rel="prefetch" href="/assets/js/21.ee328ae6.js"><link rel="prefetch" href="/assets/js/23.50b45a14.js"><link rel="prefetch" href="/assets/js/24.64f730a9.js"><link rel="prefetch" href="/assets/js/25.44907a6a.js"><link rel="prefetch" href="/assets/js/26.777e873d.js"><link rel="prefetch" href="/assets/js/27.3c651147.js"><link rel="prefetch" href="/assets/js/28.bc425acd.js"><link rel="prefetch" href="/assets/js/29.7a09b5e9.js"><link rel="prefetch" href="/assets/js/3.e8158f87.js"><link rel="prefetch" href="/assets/js/4.311ce2ab.js"><link rel="prefetch" href="/assets/js/5.78e63a13.js"><link rel="prefetch" href="/assets/js/6.ace07c65.js"><link rel="prefetch" href="/assets/js/7.fd0bb10f.js"><link rel="prefetch" href="/assets/js/8.2d08061b.js"><link rel="prefetch" href="/assets/js/9.5743d1eb.js">
    <link rel="stylesheet" href="/assets/css/0.styles.69dd57bd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="navbar-container"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="职念" class="logo"> <span class="site-name can-hide">职念</span></a> <div class="links"><div class="search-box"><input aria-label="Search" placeholder="Search" autocomplete="off" spellcheck="false" value=""> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="search-icon"><path d="M21.7,20.3L18,16.6c1.2-1.5,2-3.5,2-5.6c0-5-4-9-9-9c-5,0-9,4-9,9c0,5,4,9,9,9c2.1,0,4.1-0.7,5.6-2l3.7,3.7c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3C22.1,21.3,22.1,20.7,21.7,20.3zM4,11c0-3.9,3.1-7,7-7c3.9,0,7,3.1,7,7c0,1.9-0.8,3.7-2,4.9c0,0,0,0,0,0s0,0,0,0c-1.3,1.3-3,2-4.9,2C7.1,18,4,14.9,4,11z"></path></svg> <span class="search-command-wrapper search-command"><span class="search-command-char">⌘</span> <span class="search-command-char">K</span></span> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/" class="vp-link nav-link router-link-active">
  Guide
  </a></div><div class="nav-item"><a href="/api/" class="vp-link nav-link">
  API
  </a></div> <div class="VPNavBarAppearance appearance" data-v-19d27b0e><button type="button" aria-label="toggle dark mode" class="vt-switch vt-switch-appearance" data-v-19d27b0e><span class="vt-switch-check"><span class="vt-switch-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="vt-switch-appearance-sun"><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path> <path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path> <path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path> <path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path> <path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path> <path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path> <path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path> <path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path> <path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="vt-switch-appearance-moon"><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg></span></span></button></div> <a href="https://github.com/JobsessionDao/Jobsession" target="_blank" rel="noopener noreferrer" class="repo-link"><svg width="1em" height="1em" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33c.85 0 1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z" fill="currentColor"></path></svg> </a></nav></div></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/" class="vp-link nav-link router-link-active">
  Guide
  </a></div><div class="nav-item"><a href="/api/" class="vp-link nav-link">
  API
  </a></div> <div class="VPNavBarAppearance appearance" data-v-19d27b0e><button type="button" aria-label="toggle dark mode" class="vt-switch vt-switch-appearance" data-v-19d27b0e><span class="vt-switch-check"><span class="vt-switch-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="vt-switch-appearance-sun"><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path> <path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path> <path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path> <path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path> <path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path> <path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path> <path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path> <path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path> <path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="vt-switch-appearance-moon"><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg></span></span></button></div> <a href="https://github.com/JobsessionDao/Jobsession" target="_blank" rel="noopener noreferrer" class="repo-link"><svg width="1em" height="1em" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33c.85 0 1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z" fill="currentColor"></path></svg> </a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Guide</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/guifan.html" class="sidebar-link">代码规范</a></li><li><a href="/guide/czh.html" class="sidebar-link">页面功能说明</a></li><li><a href="/guide/database.html" class="sidebar-link">数据库设计</a></li><li><a href="/guide/databaseMethods.html" aria-current="page" class="active sidebar-link">云开发：数据库和云存储操作</a></li><li><a href="/guide/git.html" class="sidebar-link">github 协作</a></li><li><a href="/guide/reachBottom.html" class="sidebar-link">触底分页加载的实现</a></li></ul></section></li></ul> </aside> <main class="page guidedatabaseMethods.html"> <div class="theme-default-content vp-doc content__default"><h1 id="云开发-数据库和云存储操作"><a href="#云开发-数据库和云存储操作" class="header-anchor">#</a> 云开发：数据库和云存储操作</h1> <h2 id="数据库结构"><a href="#数据库结构" class="header-anchor">#</a> 数据库结构</h2> <p>云开发提供了一个 JSON 数据库，顾名思义，数据库中的每条记录都是一个 JSON 格式的对象。一个数据库可以有多个集合（相当于关系型数据中的表），集合可看做一个 JSON 数组，数组中的每个对象就是一条记录，记录的格式是 JSON 对象。</p> <p>关系型数据库和 JSON 数据库的概念对应关系如下表：</p> <p><img src="https://jetzihan-img.oss-cn-beijing.aliyuncs.com/blog/20221008101852.png" alt="1"></p> <p>以下是一个示例的集合数据，假设我们有一个 <code>books</code> 集合存放了图书记录，其中有两本书：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Wzh76lk5_O_dt0vO&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;The Catcher in the Rye&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;J. D. Salinger&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;characters&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;Holden Caulfield&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;Stradlater&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;Mr. Antolini&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;publishInfo&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;year&quot;</span><span class="token operator">:</span> <span class="token number">1951</span><span class="token punctuation">,</span>
      <span class="token property">&quot;country&quot;</span><span class="token operator">:</span> <span class="token string">&quot;United States&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Wzia0lk5_O_dt0vR&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_openid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ohl4L0Rnhq7vmmbT_DaNQa4ePaz0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;The Lady of the Camellias&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Alexandre Dumas fils&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;characters&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;Marguerite Gautier&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;Armand Duval&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;Prudence&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;Count de Varville&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;publishInfo&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;year&quot;</span><span class="token operator">:</span> <span class="token number">1848</span><span class="token punctuation">,</span>
      <span class="token property">&quot;country&quot;</span><span class="token operator">:</span> <span class="token string">&quot;France&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p>在图书信息中，我们用 title, author 来记录图书标题和作者，用 characters 数组来记录书中的主要人物，用 publishInfo 来记录图书的出版信息。在其中我们可以看到，字段既可以是字符串或数字，还可以是对象或数组，就是一个 JSON 对象。</p> <p>每条记录都有一个 _id 字段用以唯一标志一条记录、一个_openid 字段用以标志记录的创建者，即小程序的用户。需要特别注意的是，在管理端（控制台和云函数）中创建的不会有 _openid 字段，因为这是属于管理员创建的记录。开发者可以自定义_id，但不可自定义和修改 _openid 。_openid 是在文档创建时由系统根据小程序用户默认创建的，开发者可使用其来标识和定位文档。</p> <h2 id="数据库基本操作"><a href="#数据库基本操作" class="header-anchor">#</a> 数据库基本操作</h2> <h3 id="简述"><a href="#简述" class="header-anchor">#</a> 简述</h3> <p>数据库 API 分为小程序端和服务端两部分，小程序端 API 拥有严格的调用权限控制，开发者可在小程序内直接调用 API 进行非敏感数据的操作。对于有更高安全要求的数据，可在云函数内通过服务端 API 进行操作。云函数的环境是与客户端完全隔离的，在云函数上可以私密且安全的操作数据库。</p> <p>数据库 API 包含增删改查的能力，使用 API 操作数据库只需三步：<strong>获取数据库引用、构造查询/更新条件、发出请求</strong>。以下是一个在小程序中查询数据库的发表于美国的图书记录的例子：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1. 获取数据库引用</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> wx<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 2. 构造查询语句</span>
<span class="token comment">// collection 方法获取一个集合的引用</span>
<span class="token comment">// where 方法传入一个对象，数据库返回集合中字段等于指定值的 JSON 文档。</span>
<span class="token comment">// API 也支持高级的查询条件（比如大于、小于、in 等），具体见文档查看支持列表</span>
<span class="token comment">// get 方法会触发网络请求，往数据库取数据</span>
db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'books'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">publishInfo</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">country</span><span class="token operator">:</span> <span class="token string">'United States'</span>    <span class="token comment">// 限定查询条件为美国出版的图书</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 输出 [{ &quot;title&quot;: &quot;The Catcher in the Rye&quot;, ... }]</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>在我们实际应用中，可以使用这个查询语句来查询某位用户所有的贴子。</p> <h3 id="初始化数据库"><a href="#初始化数据库" class="header-anchor">#</a> 初始化数据库</h3> <p>在你的js文件中，首先需要引入数据库的SDK：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> db <span class="token operator">=</span> wx<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>如需获取其他环境的数据库引用，可以在调用时传入一个对象参数，在其中通过 env 字段指定要使用的环境。此时方法会返回一个对测试环境数据库的引用。</p> <p>示例：假设有一个环境名为 test，用做测试环境，那么可以如下获取测试环境数据库：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> db <span class="token operator">=</span> wx<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">env</span><span class="token operator">:</span> <span class="token string">'test'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>要操作一个<strong>集合</strong>，需先获取它的引用。在获取了数据库的引用后，就可以通过数据库引用上的 <code>collection</code> 方法获取一个集合的引用了，比如获取 <code>userList</code> 集合：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> userList <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'userList'</span><span class="token punctuation">)</span>
</code></pre></div><p>获取集合的引用并不会发起网络请求去拉取它的数据，我们可以通过此引用在该集合上进行增删查改的操作，除此之外，还可以通过集合上的 doc 方法来获取集合中一个指定 ID 的记录的引用。同理，记录的引用可以用于对特定记录进行更新和删除操作。</p> <p>假设我们有一个用户的 ID 为 <code>ajksib8wh52vgwiolppwjie</code>，那么我们可以通过 doc 方法获取它的引用：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> user <span class="token operator">=</span> userList<span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span><span class="token string">'ajksib8wh52vgwiolppwjie'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="插入数据"><a href="#插入数据" class="header-anchor">#</a> 插入数据</h3> <p>在获取了集合的引用后，就可以通过 <code>add</code> 方法在集合中插入一条记录了。比如我们要在 <code>userList</code> 集合中插入一条记录（用于在登录时记录用户信息）：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> userList <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'userList'</span><span class="token punctuation">)</span>
userList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">userName</span><span class="token operator">:</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">userID</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>userID<span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// res 是一个对象，其中有 _id 字段标记刚创建的记录的 id</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="查询数据"><a href="#查询数据" class="header-anchor">#</a> 查询数据</h3> <p>在获取了集合的引用后，就可以通过 <code>where</code> 方法传入一个对象，数据库返回集合中字段等于指定值的 JSON 文档。例如，这里我要查询数据库集合 <code>userList</code> 中 <code>userID</code> 等于 <code>this.data.userID</code> 的记录：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> userList <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'userList'</span><span class="token punctuation">)</span>
userList<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">userID</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>userID
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 输出 [{ &quot;title&quot;: &quot;The Catcher in the Rye&quot;, ... }]</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>或者我们要获取 <code>articleList</code> 集合中所有 <code>type</code> 值为 <code>1</code> 的记录（也就是经验贴）：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> articleList <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'articleList'</span><span class="token punctuation">)</span>
articleList<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span><span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// res.data 是一个包含集合中有权限访问的所有记录的数据，不超过 20 条</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><code>where</code> 方法接收一个对象参数，该对象中每个字段和它的值构成一个需满足的匹配条件，各个字段间的关系是 &quot;与&quot; 的关系，即需同时满足这些匹配条件，在这个例子中，就是查询出 <code>articleList</code> 集合中 <code>authorID</code>  等于 <code>this.data.userID</code> 且 <code>type</code> 等于 <code>1</code> 的记录（也就是文章数据库中所有由此位用户发布的经验贴）。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> articleList <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'articleList'</span><span class="token punctuation">)</span>
articleList<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">authorID</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>userID<span class="token punctuation">,</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span><span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// res.data 是一个包含集合中有权限访问的所有记录的数据，不超过 20 条</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>如果要获取一个集合的数据，比如获取 <code>articleList</code> 集合上的所有记录，可以在集合上调用 get 方法获取，但通常不建议这么使用，小程序不允许我们一次获取过量数据，只应获取必要的数据。为了防止误操作以及保护小程序体验，小程序端在获取集合数据时服务器一次默认并且最多返回 <strong>20</strong> 条记录，云函数端这个数字则是 <strong>100</strong>。开发者可以通过 <strong>limit</strong> 方法指定需要获取的记录数量，但小程序端<strong>不能</strong>超过 20 条，云函数端不能超过 100 条。</p> <div class="language-js extra-class"><pre class="language-js"><code>db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'articleList'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// res.data 是一个包含集合中有权限访问的所有记录的数据，不超过 20 条</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>使用云函数可以分批次获取全部数据：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> cloud <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'wx-server-sdk'</span><span class="token punctuation">)</span>
cloud<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> cloud<span class="token punctuation">.</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token constant">MAX_LIMIT</span> <span class="token operator">=</span> <span class="token number">100</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">main</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 先取出集合记录总数</span>
  <span class="token keyword">const</span> countResult <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'articleList'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> total <span class="token operator">=</span> countResult<span class="token punctuation">.</span>total
  <span class="token comment">// 计算需分几次取</span>
  <span class="token keyword">const</span> batchTimes <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>total <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">)</span>
  <span class="token comment">// 承载所有读操作的 promise 的数组</span>
  <span class="token keyword">const</span> tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> batchTimes<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> promise <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'articleList'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token constant">MAX_LIMIT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token constant">MAX_LIMIT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 等待所有</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">acc<span class="token punctuation">,</span> cur</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> acc<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>cur<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">errMsg</span><span class="token operator">:</span> acc<span class="token punctuation">.</span>errMsg<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="查询指令"><a href="#查询指令" class="header-anchor">#</a> 查询指令</h3> <p>假设我们需要查询收藏数超过 30 的文章，那么传入对象表示<strong>全等匹配</strong>的方式就无法满足了，这时就需要用到查询指令。数据库 API 提供了大于、小于等多种查询指令，这些指令都暴露在 db.command 对象上。比如收藏数（<code>number</code>）超过 30 的文章：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> articleList <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'articleList'</span><span class="token punctuation">)</span>
articleList<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// gt 方法用于指定一个 &quot;大于&quot; 条件，此处 _.gt(30) 是一个 &quot;大于 30&quot; 的条件</span>
  <span class="token literal-property property">number</span><span class="token operator">:</span> db<span class="token punctuation">.</span>command<span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// res.data 是一个包含集合中有权限访问的所有记录的数据，不超过 20 条</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>API 提供了以下查询指令：</p> <p><img src="https://jetzihan-img.oss-cn-beijing.aliyuncs.com/blog/20221008104535.png" alt="1"></p> <p>除了指定一个字段满足一个条件之外，我们还可以通过指定一个字段需同时满足多个条件，比如用 and 逻辑指令查询点赞数在 30 和 70 之间的文章：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> articleList <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'articleList'</span><span class="token punctuation">)</span>
articleList<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// and 方法用于指定一个 &quot;与&quot; 条件，此处 _.and(_.gt(30), _.lt(70)) </span>
  <span class="token comment">//是一个 &quot;大于 30 且小于 70&quot; 的条件</span>
  <span class="token literal-property property">number</span><span class="token operator">:</span> db<span class="token punctuation">.</span>command<span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>command<span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span> db<span class="token punctuation">.</span>command<span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span><span class="token number">70</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// res.data 是一个包含集合中有权限访问的所有记录的数据，不超过 20 条</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>如果我们需要跨字段进行 &quot;或&quot; 操作，可以做到吗？答案是肯定的，<code>or</code> 指令还可以用来接受多个（可以多于两个）查询条件，表示需满足多个查询条件中的任意一个，比如我们点赞（number）小于或等于 50 或类型（type）为 1 的文章：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> _ <span class="token operator">=</span> db<span class="token punctuation">.</span>command
db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'todos'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">progress</span><span class="token operator">:</span> _<span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> _<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="更新数据"><a href="#更新数据" class="header-anchor">#</a> 更新数据</h3> <p>更新数据的 API 与查询数据的 API 类似，只是调用的是 update 方法，比如我们需要将集合(userList)中当前用户(<code>this.data.userID</code>)的收藏数（number）加1：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> db <span class="token operator">=</span> wx<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> userList <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'userList'</span><span class="token punctuation">)</span>
userList<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">_openid</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>userID
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// inc 方法用于指定一个自增</span>
    <span class="token literal-property property">number</span><span class="token operator">:</span> db<span class="token punctuation">.</span>command<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>微信小程序云开发数据库 API 还提供了其他更新指令，比如：</p> <p><img src="https://jetzihan-img.oss-cn-beijing.aliyuncs.com/blog/20221008105307.png" alt="1"></p> <p><code>update</code> 字段只是局部刷新，如果需要将整个文档替换，可以使用 set 指令：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> db <span class="token operator">=</span> wx<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> userList <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'userList'</span><span class="token punctuation">)</span>
userList<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">_openid</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>userID
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// set 方法用于指定一个覆盖</span>
    <span class="token literal-property property">number</span><span class="token operator">:</span> <span class="token number">15</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="删除数据"><a href="#删除数据" class="header-anchor">#</a> 删除数据</h3> <p>删除数据的 API 与查询数据的 API 类似，只是调用的是 remove 方法，比如我们需要将集合(userList)中当前用户(<code>this.data.userID</code>)的记录删除：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> db <span class="token operator">=</span> wx<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> userList <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'userList'</span><span class="token punctuation">)</span>
userList<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">userID</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>userID
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="云存储"><a href="#云存储" class="header-anchor">#</a> 云存储</h2> <p>云开发提供了一块存储空间，提供了上传文件到云端、带权限管理的云端下载能力，开发者可以在小程序端和云函数端通过 API 使用云存储功能。</p> <p>在小程序端可以分别调用 <code>wx.cloud.uploadFile</code> 和 <code>wx.cloud.downloadFile</code> 完成上传和下载云文件操作。下面简单的几行代码，即可实现在小程序内让用户选择一张图片，然后上传到云端管理的功能：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 让用户选择一张图片</span>
wx<span class="token punctuation">.</span><span class="token function">chooseImage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token parameter">chooseResult</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将图片上传至云存储空间</span>
    wx<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span><span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// 指定上传到的云路径</span>
      <span class="token literal-property property">cloudPath</span><span class="token operator">:</span> <span class="token string">'my-photo.png'</span><span class="token punctuation">,</span>
      <span class="token comment">// 指定要上传的文件的小程序临时文件路径</span>
      <span class="token literal-property property">filePath</span><span class="token operator">:</span> chooseResult<span class="token punctuation">.</span>tempFilePaths<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token comment">// 成功回调</span>
      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'上传成功'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><div class="inner"><a href="/guide/database.html" class="vp-link prev"><span>←</span>
  数据库设计
  <span><br> <span class="prev-link">/guide/database.html</span></span></a> <a href="/guide/git.html" class="vp-link next">
  github 协作
  <span>
        →
        <br> <span class="next-link">/guide/git.html</span></span></a></div></div> </main> <div class="sticker vuepress-toc"><div class="on-this-page">ON THIS PAGE</div> <div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#数据库结构" title="数据库结构">数据库结构</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#数据库基本操作" title="数据库基本操作">数据库基本操作</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#简述" title="简述">简述</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#初始化数据库" title="初始化数据库">初始化数据库</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#插入数据" title="插入数据">插入数据</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#查询数据" title="查询数据">查询数据</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#查询指令" title="查询指令">查询指令</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#更新数据" title="更新数据">更新数据</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#删除数据" title="删除数据">删除数据</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#云存储" title="云存储">云存储</a></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9bb55e6e.js" defer></script><script src="/assets/js/2.6f94c7ae.js" defer></script><script src="/assets/js/12.26daf54b.js" defer></script><script src="/assets/js/22.1a0921fe.js" defer></script>
  </body>
</html>
